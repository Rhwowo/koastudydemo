# 微博程序API服务架构设计方案

## 1. 系统架构概览

### 1.1 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                        负载均衡层                              │
│                        Nginx                                 │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────────┐
│                      API网关层                               │
│                    Koa.js Server                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   路由层    │  │   中间件    │  │  控制器层   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────────┐
│                      服务层                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  用户服务   │  │  微博服务   │  │  互动服务   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  文件服务   │  │  通知服务   │  │  搜索服务   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────┴───────────────────────────────────────┐
│                      数据层                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   MySQL     │  │    Redis    │  │  文件存储   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术架构特点
- **分层架构**：清晰的分层结构，降低耦合度
- **微服务预留**：支持未来服务拆分
- **高可用性**：支持水平扩展和负载均衡
- **数据一致性**：通过事务和消息队列保证

## 2. 目录结构

```
weibo-api/
├── src/
│   ├── config/              # 配置文件
│   │   ├── database.js     # 数据库配置
│   │   ├── jwt.js          # JWT配置
│   │   ├── upload.js       # 上传配置
│   │   └── swagger.js      # API文档配置
│   ├── controllers/        # 控制器层
│   │   ├── auth.controller.js
│   │   ├── user.controller.js
│   │   ├── post.controller.js
│   │   ├── comment.controller.js
│   │   ├── like.controller.js
│   │   ├── follow.controller.js
│   │   └── upload.controller.js
│   ├── services/          # 服务层
│   │   ├── auth.service.js
│   │   ├── user.service.js
│   │   ├── post.service.js
│   │   ├── comment.service.js
│   │   ├── like.service.js
│   │   ├── follow.service.js
│   │   └── file.service.js
│   ├── models/            # 数据模型层
│   │   ├── user.model.js
│   │   ├── post.model.js
│   │   ├── comment.model.js
│   │   ├── like.model.js
│   │   ├── follow.model.js
│   │   └── index.js       # 模型关联
│   ├── routes/           # 路由层
│   │   ├── index.js       # 路由总览
│   │   ├── auth.routes.js
│   │   ├── user.routes.js
│   │   ├── post.routes.js
│   │   ├── comment.routes.js
│   │   ├── like.routes.js
│   │   └── follow.routes.js
│   ├── middlewares/      # 中间件
│   │   ├── auth.middleware.js
│   │   ├── error.middleware.js
│   │   ├── logger.middleware.js
│   │   └── rateLimit.middleware.js
│   ├── utils/            # 工具类
│   │   ├── response.js    # 统一响应格式
│   │   ├── validator.js   # 数据验证
│   │   ├── logger.js      # 日志工具
│   │   └── crypto.js      # 加密工具
│   ├── uploads/          # 上传文件目录
│   │   ├── avatars/       # 用户头像
│   │   └── images/        # 微博图片
│   └── app.js            # 应用入口
├── tests/                 # 测试文件
│   ├── unit/
│   ├── integration/
│   └── fixtures/
├── docs/                  # 文档
│   ├── api/
│   └── database/
├── scripts/              # 脚本文件
│   ├── migrate.js
│   └── seed.js
├── logs/                 # 日志文件
├── .env.example          # 环境变量示例
├── .gitignore
├── .eslintrc.js
├── .prettierrc
├── package.json
├── docker-compose.yml
└── README.md
```

## 3. 模块划分

### 3.1 核心业务模块

#### 3.1.1 用户模块 (User Module)
- **功能**：用户注册、登录、信息管理
- **路由**：/api/v1/users
- **控制器**：user.controller.js
- **服务**：user.service.js
- **模型**：user.model.js

#### 3.1.2 微博模块 (Post Module)
- **功能**：微博发布、查询、删除
- **路由**：/api/v1/posts
- **控制器**：post.controller.js
- **服务**：post.service.js
- **模型**：post.model.js

#### 3.1.3 互动模块 (Interaction Module)
- **子模块**：
  - 点赞模块 (Like)
  - 评论模块 (Comment)
  - 关注模块 (Follow)
- **路由**：
  - /api/v1/likes
  - /api/v1/comments
  - /api/v1/follows

### 3.2 支撑模块

#### 3.2.1 认证模块 (Auth Module)
- **功能**：JWT Token生成与验证
- **中间件**：auth.middleware.js
- **服务**：auth.service.js

#### 3.2.2 文件模块 (File Module)
- **功能**：图片上传、文件管理
- **控制器**：upload.controller.js
- **服务**：file.service.js

#### 3.2.3 通知模块 (Notification Module)
- **功能**：消息推送、通知管理
- **预留**：未来扩展为独立服务

## 4. 数据流图

### 4.1 用户注册流程
```
用户注册请求 → 路由层 → 验证中间件 → 用户控制器 → 用户服务 → 数据库 → 返回结果
     ↓
  数据验证 → 密码加密 → 创建用户 → 生成Token → 返回用户信息
```

### 4.2 微博发布流程
```
发布微博请求 → 认证中间件 → 微博控制器 → 微博服务 → 数据库 → 返回结果
     ↓
  验证Token → 数据验证 → 保存微博 → 更新用户统计 → 推送通知
```

### 4.3 获取微博列表流程
```
获取列表请求 → 认证中间件 → 微博控制器 → 微博服务 → 数据库 → 组装数据 → 返回结果
     ↓
  验证Token → 分页参数 → 查询微博 → 获取用户信息 → 获取互动数据 → 返回列表
```

### 4.4 关注用户流程
```
关注请求 → 认证中间件 → 关注控制器 → 关注服务 → 数据库 → 返回结果
     ↓
  验证Token → 检查用户 → 创建关注 → 更新粉丝数 → 发送通知
```

## 5. 数据库设计

### 5.1 实体关系图
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│    users    │    │   posts     │    │  comments   │
├─────────────┤    ├─────────────┤    ├─────────────┤
│ id (PK)     │1  *│ id (PK)     │1  *│ id (PK)     │
│ username    │─────│ user_id     │─────│ post_id     │
│ email       │    │ content     │    │ user_id     │
│ password    │    │ images      │    │ content     │
│ nickname    │    │ created_at  │    │ created_at  │
│ avatar      │    └─────────────┘    └─────────────┘
│ created_at  │
└─────────────┘
       │ 1                 │ 1                 │ 1
       │                   │                   │
       │ *                 │ *                 │ *
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   likes     │    │  follows    │    │   images    │
├─────────────┤    ├─────────────┤    ├─────────────┤
│ id (PK)     │    │ id (PK)     │    │ id (PK)     │
│ user_id     │    │ follower_id │    │ post_id     │
│ post_id     │    │ following_id│    │ url         │
│ created_at  │    │ created_at  │    │ created_at  │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 5.2 数据表结构

#### 5.2.1 用户表 (users)
```sql
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) UNIQUE NOT NULL,
  email VARCHAR(100) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,
  nickname VARCHAR(50) NOT NULL,
  avatar VARCHAR(255),
  bio TEXT,
  followers_count INT DEFAULT 0,
  following_count INT DEFAULT 0,
  posts_count INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP NULL
);
```

#### 5.2.2 微博表 (posts)
```sql
CREATE TABLE posts (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  content TEXT NOT NULL,
  images JSON,
  likes_count INT DEFAULT 0,
  comments_count INT DEFAULT 0,
  forwards_count INT DEFAULT 0,
  is_deleted BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id)
);
```

#### 5.2.3 评论表 (comments)
```sql
CREATE TABLE comments (
  id INT PRIMARY KEY AUTO_INCREMENT,
  post_id INT NOT NULL,
  user_id INT NOT NULL,
  content TEXT NOT NULL,
  parent_id INT DEFAULT NULL,
  likes_count INT DEFAULT 0,
  is_deleted BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (post_id) REFERENCES posts(id),
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (parent_id) REFERENCES comments(id)
);
```

#### 5.2.4 点赞表 (likes)
```sql
CREATE TABLE likes (
  id INT PRIMARY KEY AUTO_INCREMENT,
  user_id INT NOT NULL,
  post_id INT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY unique_user_post (user_id, post_id),
  FOREIGN KEY (user_id) REFERENCES users(id),
  FOREIGN KEY (post_id) REFERENCES posts(id)
);
```

#### 5.2.5 关注表 (follows)
```sql
CREATE TABLE follows (
  id INT PRIMARY KEY AUTO_INCREMENT,
  follower_id INT NOT NULL,
  following_id INT NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY unique_follow (follower_id, following_id),
  FOREIGN KEY (follower_id) REFERENCES users(id),
  FOREIGN KEY (following_id) REFERENCES users(id)
);
```

## 6. 缓存策略

### 6.1 Redis缓存设计
- **用户缓存**：用户信息缓存（TTL: 1小时）
- **微博缓存**：热门微博缓存（TTL: 30分钟）
- **关注列表**：用户关注列表缓存（TTL: 15分钟）
- **计数器**：点赞数、评论数实时更新

### 6.2 缓存更新策略
- **写后删除**：数据更新时删除缓存
- **定时刷新**：定时任务更新缓存
- **懒加载**：首次访问时加载缓存

## 7. 安全设计

### 7.1 认证授权
- **JWT Token**：用户身份认证
- **权限控制**：基于角色的访问控制
- **API限流**：防止恶意请求

### 7.2 数据安全
- **密码加密**：bcrypt加密存储
- **敏感信息脱敏**：用户隐私信息保护
- **SQL注入防护**：参数化查询
- **XSS防护**：输入数据过滤

## 8. 监控告警

### 8.1 监控指标
- **系统指标**：CPU、内存、磁盘、网络
- **应用指标**：QPS、响应时间、错误率
- **业务指标**：用户注册数、微博发布数

### 8.2 告警机制
- **阈值告警**：响应时间 > 500ms
- **异常告警**：错误率 > 5%
- **业务告警**：关键业务流程异常